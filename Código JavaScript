CENTROS MÉDICOS

// Constantes para la API
const API_URL = 'https://localhost:7207/api/CentroMedicos';

// Elementos del DOM
const centroMedicoForm = document.getElementById('centroMedicoForm');
const centroIdInput = document.getElementById('centroId');
const nombreInput = document.getElementById('nombre');
const ciudadInput = document.getElementById('ciudad');
const direccionInput = document.getElementById('direccion');
const telefonoInput = document.getElementById('telefono');
const btnLimpiar = document.getElementById('btnLimpiar');
const btnBuscar = document.getElementById('btnBuscar');
const searchInput = document.getElementById('searchInput');
const tablaCentrosMedicos = document.getElementById('tablaCentrosMedicos').getElementsByTagName('tbody')[0];

// Función para cargar todos los centros médicos
async function cargarCentrosMedicos() {
  try {
    const response = await fetch(API_URL);
    if (!response.ok) {
      throw new Error('Error al cargar los centros médicos');
    }
    const data = await response.json();
    // Extraer el array de valores desde la respuesta
    const centrosMedicos = data.$values || [];
    mostrarCentrosMedicos(centrosMedicos);
  } catch (error) {
    console.error('Error:', error);
    alert('No se pudieron cargar los centros médicos. Por favor, intente nuevamente.');
  }
}

// Función para mostrar los centros médicos en la tabla
function mostrarCentrosMedicos(centrosMedicos) {
  // Limpiar la tabla
  tablaCentrosMedicos.innerHTML = '';
  
  // Verificar si hay centros para mostrar
  if (!centrosMedicos || centrosMedicos.length === 0) {
    const row = tablaCentrosMedicos.insertRow();
    const cell = row.insertCell(0);
    cell.colSpan = 6;
    cell.textContent = 'No hay centros médicos disponibles';
    cell.style.textAlign = 'center';
    return;
  }
  
  // Llenar la tabla con los datos
  centrosMedicos.forEach(centro => {
    const row = tablaCentrosMedicos.insertRow();
    
    row.insertCell(0).textContent = centro.centroID;
    row.insertCell(1).textContent = centro.nombre;
    row.insertCell(2).textContent = centro.ciudad;
    
    const cellDireccion = row.insertCell(3);
    cellDireccion.textContent = centro.direccion || '';
    cellDireccion.classList.add('direccion-cell');
    
    row.insertCell(4).textContent = centro.telefono || '';
    
    // Celda para acciones (editar y eliminar)
    const cellAcciones = row.insertCell(5);
    
    // Botón editar
    const btnEditar = document.createElement('button');
    btnEditar.innerHTML = '<i class="fas fa-edit"></i>';
    btnEditar.className = 'btn-action btn-edit';
    btnEditar.title = 'Editar';
    btnEditar.onclick = () => cargarCentroParaEditar(centro);
    cellAcciones.appendChild(btnEditar);
    
    // Botón eliminar
    const btnEliminar = document.createElement('button');
    btnEliminar.innerHTML = '<i class="fas fa-trash-alt"></i>';
    btnEliminar.className = 'btn-action btn-delete';
    btnEliminar.title = 'Eliminar';
    btnEliminar.onclick = () => eliminarCentroMedico(centro.centroID);
    cellAcciones.appendChild(btnEliminar);
  });
}

// Función para buscar centros médicos
async function buscarCentrosMedicos() {
  const searchTerm = searchInput.value.trim();
  
  try {
    let url = API_URL;
    if (searchTerm) {
      url = `${API_URL}/buscar?nombre=${encodeURIComponent(searchTerm)}`;
    }
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Error en la búsqueda');
    }
    
    const data = await response.json();
    // Extraer el array de valores desde la respuesta
    const centrosMedicos = data.$values || [];
    mostrarCentrosMedicos(centrosMedicos);
  } catch (error) {
    console.error('Error:', error);
    alert('Error al realizar la búsqueda. Por favor, intente nuevamente.');
  }
}

// Función para guardar un centro médico (crear o actualizar)
async function guardarCentroMedico(event) {
  event.preventDefault();
  
  const centroMedico = {
    nombre: nombreInput.value,
    ciudad: ciudadInput.value,
    direccion: direccionInput.value,
    telefono: telefonoInput.value,
    medicos: [] // Añadimos el campo 'medicos' vacío para mantener la estructura
  };
  
  const id = centroIdInput.value;
  const isEditing = id !== '';
  
  if (isEditing) {
    centroMedico.centroID = parseInt(id);
  }
  
  try {
    const url = isEditing ? `${API_URL}/${id}` : API_URL;
    const method = isEditing ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(centroMedico)
    });
    
    if (!response.ok) {
      throw new Error(`Error al ${isEditing ? 'actualizar' : 'crear'} el centro médico`);
    }
    
    // Limpiar el formulario y recargar los datos
    limpiarFormulario();
    cargarCentrosMedicos();
    
    alert(`Centro médico ${isEditing ? 'actualizado' : 'creado'} correctamente`);
  } catch (error) {
    console.error('Error:', error);
    alert(`Error al ${isEditing ? 'actualizar' : 'crear'} el centro médico. Por favor, intente nuevamente.`);
  }
}

// Función para cargar un centro médico para editar
function cargarCentroParaEditar(centro) {
  centroIdInput.value = centro.centroID;
  nombreInput.value = centro.nombre;
  ciudadInput.value = centro.ciudad;
  direccionInput.value = centro.direccion || '';
  telefonoInput.value = centro.telefono || '';
  
  // Cambiar texto del formulario
  document.querySelector('.form-section h2').textContent = 'Editar Centro Médico';
}

// Función para eliminar un centro médico
async function eliminarCentroMedico(id) {
  if (!confirm('¿Está seguro que desea eliminar este centro médico?')) {
    return;
  }
  
  try {
    const response = await fetch(`${API_URL}/${id}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      throw new Error('Error al eliminar el centro médico');
    }
    
    // Recargar la lista de centros médicos
    cargarCentrosMedicos();
    alert('Centro médico eliminado correctamente');
  } catch (error) {
    console.error('Error:', error);
    alert('Error al eliminar el centro médico. Por favor, intente nuevamente.');
  }
}

// Función para limpiar el formulario
function limpiarFormulario() {
  centroMedicoForm.reset();
  centroIdInput.value = '';
  document.querySelector('.form-section h2').textContent = 'Nuevo Centro Médico';
}

// Event Listeners
window.addEventListener('DOMContentLoaded', cargarCentrosMedicos);
centroMedicoForm.addEventListener('submit', guardarCentroMedico);
btnLimpiar.addEventListener('click', limpiarFormulario);
btnBuscar.addEventListener('click', buscarCentrosMedicos);
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    buscarCentrosMedicos();
  }
});

CLIENTES

// Variables globales
const API_URL = 'https://localhost:7207/api/ClientesApi';
let clientes = [];
let clienteActual = null;

// Elementos DOM
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menu-toggle');
const closeMenu = document.getElementById('close-menu');
const clienteForm = document.getElementById('clienteForm');
const formTitle = document.getElementById('formTitle');
const btnLimpiar = document.getElementById('btnLimpiar');
const searchInput = document.getElementById('searchInput');
const filterTipo = document.getElementById('filterTipo');
const btnBuscar = document.getElementById('btnBuscar');
const tablaClientes = document.getElementById('tablaClientes');
const clienteModal = document.getElementById('clienteModal');
const closeModal = document.querySelector('.close');

// ==================== Funcionalidad Menú Hamburguesa ====================
menuToggle.addEventListener('click', () => {
  sidebar.classList.add('active');
  overlay.classList.add('active');
});

closeMenu.addEventListener('click', () => {
  sidebar.classList.remove('active');
  overlay.classList.remove('active');
});

overlay.addEventListener('click', () => {
  sidebar.classList.remove('active');
  overlay.classList.remove('active');
});

// ==================== Funciones para gestionar clientes ====================

// Cargar todos los clientes
async function cargarClientes() {
  try {
    const response = await fetch(API_URL);
    if (!response.ok) {
      throw new Error('Error al cargar los clientes');
    }
    
    const data = await response.json();
    // Acceder a los valores dentro de la estructura de respuesta
    clientes = data.$values || [];
    mostrarClientes(clientes);
  } catch (error) {
    console.error('Error:', error);
    alert('No se pudieron cargar los clientes. Por favor, intente nuevamente.');
  }
}

// Mostrar los clientes en la tabla
function mostrarClientes(clientesArray) {
  const tbody = tablaClientes.querySelector('tbody');
  tbody.innerHTML = '';

  if (clientesArray.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = '<td colspan="6" class="text-center">No hay clientes disponibles</td>';
    tbody.appendChild(row);
    return;
  }

  clientesArray.forEach(cliente => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${cliente.clienteID}</td>
      <td>${cliente.nombre}</td>
      <td>${cliente.apellido}</td>
      <td class="truncate">${cliente.correo || '-'}</td>
      <td>${cliente.telefono || '-'}</td>
      <td>
        <button class="btn-action btn-view" data-id="${cliente.clienteID}" aria-label="Ver detalles">
          <i class="fas fa-eye"></i>
        </button>
        <button class="btn-action btn-edit" data-id="${cliente.clienteID}" aria-label="Editar">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn-action btn-delete" data-id="${cliente.clienteID}" aria-label="Eliminar">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // Agregar event listeners a los botones
  agregarEventosAcciones();
}

// Agregar eventos a los botones de acción
function agregarEventosAcciones() {
  // Botones de ver detalles
  document.querySelectorAll('.btn-view').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const clienteId = parseInt(e.currentTarget.dataset.id);
      cargarDetallesCliente(clienteId);
    });
  });

  // Botones de editar
  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const clienteId = parseInt(e.currentTarget.dataset.id);
      cargarClienteParaEditar(clienteId);
    });
  });

  // Botones de eliminar
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const clienteId = parseInt(e.currentTarget.dataset.id);
      confirmarEliminacion(clienteId);
    });
  });
}

// Cargar un cliente para editar
async function cargarClienteParaEditar(id) {
  try {
    const response = await fetch(`${API_URL}/${id}`);
    if (!response.ok) {
      throw new Error('Error al cargar el cliente');
    }
    
    clienteActual = await response.json();
    
    // Llenar el formulario con los datos
    document.getElementById('clienteId').value = clienteActual.clienteID;
    document.getElementById('nombre').value = clienteActual.nombre;
    document.getElementById('apellido').value = clienteActual.apellido;
    document.getElementById('correo').value = clienteActual.correo || '';
    document.getElementById('telefono').value = clienteActual.telefono || '';
    
    // Estos campos no existen en el modelo actual, pero están en el HTML
    // Si se agregan a la API, descomenta estas líneas
    /*
    document.getElementById('fechaNacimiento').value = clienteActual.fechaNacimiento || '';
    document.getElementById('direccion').value = clienteActual.direccion || '';
    */
    
    formTitle.innerText = 'Editar Cliente';
  } catch (error) {
    console.error('Error:', error);
    alert('No se pudo cargar el cliente para editar. Por favor, intente nuevamente.');
  }
}

// Cargar detalles de un cliente para mostrar en el modal
async function cargarDetallesCliente(id) {
  try {
    const response = await fetch(`${API_URL}/${id}`);
    if (!response.ok) {
      throw new Error('Error al cargar los detalles del cliente');
    }
    
    const cliente = await response.json();
    
    // Llenar el modal con los datos
    document.getElementById('detailNombreCompleto').textContent = `${cliente.nombre} ${cliente.apellido}`;
    document.getElementById('detailCorreo').textContent = cliente.correo || 'No registrado';
    document.getElementById('detailTelefono').textContent = cliente.telefono || 'No registrado';
    
    // Estos campos no existen en el modelo actual, mostrar valor por defecto
    document.getElementById('detailFechaNacimiento').textContent = 'No registrado';
    document.getElementById('detailDireccion').textContent = 'No registrado';
    document.getElementById('detailUltimaConsulta').textContent = 'No hay consultas registradas';
    
    // Cargar consultas del cliente (si existen)
    const tbodyHistorial = document.querySelector('#tablaHistorialConsultas tbody');
    tbodyHistorial.innerHTML = '';
    
    if (cliente.consultas && cliente.consultas.$values && cliente.consultas.$values.length > 0) {
      cliente.consultas.$values.forEach(consulta => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatDate(consulta.fechaConsulta)}</td>
          <td>Dr(a). ${consulta.medicoID}</td>
          <td>${consulta.diagnostico || 'No registrado'}</td>
        `;
        tbodyHistorial.appendChild(row);
      });
      
      // Actualizar última consulta si hay datos
      if (cliente.consultas.$values.length > 0) {
        // Ordenar consultas por fecha para encontrar la más reciente
        const consultasOrdenadas = [...cliente.consultas.$values].sort((a, b) => 
          new Date(b.fechaConsulta) - new Date(a.fechaConsulta)
        );
        document.getElementById('detailUltimaConsulta').textContent = 
          `${formatDate(consultasOrdenadas[0].fechaConsulta)} con Dr(a). ${consultasOrdenadas[0].medicoID}`;
      }
    } else {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="3" class="text-center">No hay consultas registradas</td>';
      tbodyHistorial.appendChild(row);
    }
    
    // Mostrar modal
    clienteModal.style.display = 'block';
  } catch (error) {
    console.error('Error:', error);
    alert('No se pudieron cargar los detalles del cliente. Por favor, intente nuevamente.');
  }
}

// Guardar cliente (crear o actualizar)
async function guardarCliente(event) {
  event.preventDefault();
  
  const clienteId = document.getElementById('clienteId').value;
  const esNuevo = !clienteId;
  
  // Crear objeto con los datos del formulario
  const clienteData = {
    nombre: document.getElementById('nombre').value,
    apellido: document.getElementById('apellido').value,
    correo: document.getElementById('correo').value,
    telefono: document.getElementById('telefono').value
  };
  
  // Si es una edición, agregar el ID
  if (!esNuevo) {
    clienteData.clienteID = parseInt(clienteId);
    // Mantener la referencia a consultas si existe
    if (clienteActual && clienteActual.consultas) {
      clienteData.consultas = clienteActual.consultas;
    }
  }
  
  try {
    const url = esNuevo ? API_URL : `${API_URL}/${clienteData.clienteID}`;
    const method = esNuevo ? 'POST' : 'PUT';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(clienteData)
    });
    
    if (!response.ok) {
      throw new Error(`Error al ${esNuevo ? 'crear' : 'actualizar'} el cliente`);
    }
    
    alert(`Cliente ${esNuevo ? 'creado' : 'actualizado'} exitosamente`);
    limpiarFormulario();
    cargarClientes();
  } catch (error) {
    console.error('Error:', error);
    alert(`No se pudo ${esNuevo ? 'crear' : 'actualizar'} el cliente. Por favor, intente nuevamente.`);
  }
}

// Confirmar eliminación de cliente
function confirmarEliminacion(id) {
  if (confirm('¿Está seguro de que desea eliminar este cliente? Esta acción no se puede deshacer.')) {
    eliminarCliente(id);
  }
}

// Eliminar cliente
async function eliminarCliente(id) {
  try {
    const response = await fetch(`${API_URL}/${id}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      // Si el servidor devuelve un error, intentar obtener el mensaje
      const errorData = await response.json().catch(() => null);
      throw new Error(errorData?.message || 'Error al eliminar el cliente');
    }
    
    alert('Cliente eliminado exitosamente');
    cargarClientes();
  } catch (error) {
    console.error('Error:', error);
    alert('No se pudo eliminar el cliente. Verifique si tiene consultas asociadas.');
  }
}

// Limpiar formulario
function limpiarFormulario() {
  clienteForm.reset();
  document.getElementById('clienteId').value = '';
  formTitle.innerText = 'Nuevo Cliente';
  clienteActual = null;
}

// Buscar clientes
function buscarClientes() {
  const searchTerm = searchInput.value.toLowerCase();
  const filtroTipo = filterTipo.value;
  
  // Filtrar por término de búsqueda
  let clientesFiltrados = clientes.filter(cliente => {
    return cliente.nombre.toLowerCase().includes(searchTerm) ||
           cliente.apellido.toLowerCase().includes(searchTerm) ||
           (cliente.correo && cliente.correo.toLowerCase().includes(searchTerm));
  });
  
  // Si hay filtros adicionales, aplicarlos
  // (En este caso el filtro no aplica porque no tenemos un campo de estado en el modelo)
  if (filtroTipo) {
    // Implementar lógica de filtrado adicional cuando se agregue el campo
  }
  
  mostrarClientes(clientesFiltrados);
}

// Formatear fecha para mostrar
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  
  const date = new Date(dateString);
  return date.toLocaleDateString('es-ES', {
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// ==================== Event Listeners ====================

// Evento submit del formulario
clienteForm.addEventListener('submit', guardarCliente);

// Evento botón limpiar
btnLimpiar.addEventListener('click', limpiarFormulario);

// Evento botón buscar
btnBuscar.addEventListener('click', buscarClientes);

// Evento input de búsqueda (búsqueda en tiempo real)
searchInput.addEventListener('input', buscarClientes);

// Evento cambio de filtro
filterTipo.addEventListener('change', buscarClientes);

// Evento cerrar modal
closeModal.addEventListener('click', () => {
  clienteModal.style.display = 'none';
});

// Cerrar modal al hacer clic fuera de él
window.addEventListener('click', (e) => {
  if (e.target === clienteModal) {
    clienteModal.style.display = 'none';
  }
});

// Cargar clientes al iniciar la página
document.addEventListener('DOMContentLoaded', () => {
  cargarClientes();
});

CONSULTA

// URLs de las API
    const URL_API_MEDICOS = 'https://localhost:7207/api/MedicosApi';
    const URL_API_ESPECIALIDADES = 'https://localhost:7207/api/Especialidades';
    const URL_API_CLIENTES = 'https://localhost:7207/api/ClientesApi';
    const URL_API_CONSULTAS = 'https://localhost:7207/api/ConsultasApi';

    // Referencias a elementos del DOM
    const sidebarElement = document.getElementById('sidebar');
    const overlayElement = document.getElementById('overlay');
    const menuToggleBtn = document.getElementById('menu-toggle');
    const closeMenuBtn = document.getElementById('close-menu');
    const formConsulta = document.getElementById('consultaForm');
    const selectEspecialidad = document.getElementById('especialidad');
    const selectMedico = document.getElementById('medico');
    const selectCliente = document.getElementById('cliente');
    const consultaModal = document.getElementById('consultaModal');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const btnBuscar = document.getElementById('btnBuscar');
    const filterEspecialidad = document.getElementById('filterEspecialidad');
    const filterMedico = document.getElementById('filterMedico');
    const filterFecha = document.getElementById('filterFecha');
    const searchInput = document.getElementById('searchInput');
    const closeModalBtn = document.querySelector('.close');

    // Almacenamiento de datos
    let especialidades = [];
    let medicos = [];
    let clientes = [];
    let consultas = [];
    let consultaEditando = null;

    // Inicialización
    inicializarEventos();

    async function inicializar() {
        inicializarEventos();
        
        try {
            // Cargar datos secuencialmente para garantizar el orden
            await cargarEspecialidades();
            await cargarMedicos();
            await cargarClientes();
            // Solo cargar consultas cuando todo lo demás ha terminado
            await cargarConsultas();
        } catch (error) {
            console.error('Error durante la inicialización:', error);
            mostrarMensaje('Error al cargar datos. Por favor, recargue la página.', 'error');
        }
    }
    
    // Llamar a la función de inicialización
    inicializar();

    // Funciones de inicialización
    function inicializarEventos() {
        // Eventos del menú hamburguesa
        menuToggleBtn.addEventListener('click', abrirMenu);
        closeMenuBtn.addEventListener('click', cerrarMenu);
        overlayElement.addEventListener('click', cerrarMenu);

        // Eventos del formulario
        formConsulta.addEventListener('submit', guardarConsulta);
        btnLimpiar.addEventListener('click', limpiarFormulario);
        selectEspecialidad.addEventListener('change', filtrarMedicosPorEspecialidad);

        // Eventos de búsqueda y filtros
        btnBuscar.addEventListener('click', aplicarFiltros);
        filterEspecialidad.addEventListener('change', actualizarFiltroMedicos);
        
        // Evento del modal
        closeModalBtn.addEventListener('click', cerrarModal);
    }

    // Funciones del menú hamburguesa
    function abrirMenu() {
        sidebarElement.classList.add('active');
        overlayElement.classList.add('active');
    }

    function cerrarMenu() {
        sidebarElement.classList.remove('active');
        overlayElement.classList.remove('active');
    }

    // Funciones de carga de datos
    async function cargarEspecialidades() {
        try {
            const response = await fetch(URL_API_ESPECIALIDADES);
            if (!response.ok) throw new Error('Error al cargar especialidades');
            
            const data = await response.json();
            especialidades = data.$values || [];
            
            // Llenar selector de especialidades en el formulario
            selectEspecialidad.innerHTML = '<option value="">Seleccionar especialidad</option>';
            filterEspecialidad.innerHTML = '<option value="">Todas las especialidades</option>';
            
            especialidades.forEach(esp => {
                // Para el formulario
                const optionForm = document.createElement('option');
                optionForm.value = esp.especialidadID;
                optionForm.textContent = esp.nombre;
                selectEspecialidad.appendChild(optionForm);
                
                // Para el filtro
                const optionFilter = document.createElement('option');
                optionFilter.value = esp.especialidadID;
                optionFilter.textContent = esp.nombre;
                filterEspecialidad.appendChild(optionFilter);
            });
            
            console.log('Especialidades cargadas:', especialidades);
        } catch (error) {
            console.error('Error al cargar especialidades:', error);
            mostrarMensaje('Error al cargar especialidades', 'error');
            throw error; // Propagar el error para manejarlo en inicializar()
        }
    }

    async function cargarMedicos() {
        try {
            const response = await fetch(URL_API_MEDICOS);
            if (!response.ok) throw new Error('Error al cargar médicos');
            
            const data = await response.json();
            
            // Procesamiento mejorado para manejar diferentes estructuras de respuesta
            if (data.$values) {
                // Si es un array dentro de $values
                medicos = procesarDatosMedicos(data.$values);
            } else if (Array.isArray(data)) {
                // Si es un array directamente
                medicos = procesarDatosMedicos(data);
            } else {
                // Si es otro formato
                console.error('Formato de datos de médicos inesperado:', data);
                medicos = [];
            }
            
            console.log('Médicos cargados:', medicos);
            
            // Después de cargar médicos, si hay una especialidad seleccionada, actualizar selectores
            if (selectEspecialidad.value) {
                filtrarMedicosPorEspecialidad();
            }
            
            actualizarFiltroMedicos();
        } catch (error) {
            console.error('Error al cargar médicos:', error);
            mostrarMensaje('Error al cargar médicos', 'error');
        }
    }
    
    // Función para procesar los datos de médicos en diferentes formatos
// Función mejorada para procesar los datos de médicos
function procesarDatosMedicos(datos) {
    // Crear un mapa para resolver las referencias
    const refMap = new Map();
    
    // Primera pasada: construir el mapa de referencias
    function buildRefMap(obj) {
        if (!obj) return;
        
        if (obj.$id) {
            refMap.set(obj.$id, obj);
        }
        
        // Procesar objetos anidados
        for (const key in obj) {
            if (typeof obj[key] === 'object' && obj[key] !== null) {
                buildRefMap(obj[key]);
            }
        }
    }
    
    // Construir el mapa de referencias desde los datos
    datos.forEach(buildRefMap);
    
    // Segunda pasada: procesar los médicos
    const medicosProcessed = [];
    
    datos.forEach(med => {
        // Si es una referencia, buscar el objeto original
        if (med.$ref) {
            med = refMap.get(med.$ref);
            if (!med) return; // Si no se encuentra la referencia, saltar
        }
        
        // Extraer la información básica del médico
        const medico = {
            medicoID: med.medicoID,
            nombre: med.nombre,
            apellido: med.apellido,
            especialidadID: med.especialidadID,
            centroID: med.centroID,
            email: med.email,
            telefono: med.telefono
        };
        
        // Añadir información de especialidad si está disponible
        if (med.especialidad) {
            // Si especialidad es una referencia, resolverla
            let especialidad = med.especialidad;
            if (especialidad.$ref) {
                especialidad = refMap.get(especialidad.$ref);
            }
            
            if (especialidad) {
                medico.especialidad = {
                    especialidadID: especialidad.especialidadID,
                    nombre: especialidad.nombre,
                    descripcion: especialidad.descripcion
                };
            }
        }
        
        // Añadir información de centro si está disponible
        if (med.centro) {
            // Si centro es una referencia, resolverla
            let centro = med.centro;
            if (centro.$ref) {
                centro = refMap.get(centro.$ref);
            }
            
            if (centro) {
                medico.centro = {
                    centroID: centro.centroID,
                    nombre: centro.nombre,
                    ciudad: centro.ciudad,
                    direccion: centro.direccion,
                    telefono: centro.telefono
                };
            }
        }
        
        // Verificar si este médico ya existe en el array (para evitar duplicados)
        const medicoExistente = medicosProcessed.find(m => m.medicoID === medico.medicoID);
        if (!medicoExistente) {
            medicosProcessed.push(medico);
        }
    });
    
    console.log('Médicos procesados:', medicosProcessed);
    return medicosProcessed;
}

    async function cargarClientes() {
        try {
            const response = await fetch(URL_API_CLIENTES);
            if (!response.ok) throw new Error('Error al cargar clientes');
            
            const data = await response.json();
            
            if (data.$values) {
                clientes = data.$values;
            } else if (Array.isArray(data)) {
                clientes = data;
            } else {
                console.error('Formato de datos de clientes inesperado:', data);
                clientes = [];
            }
            
            // Llenar selector de clientes
            selectCliente.innerHTML = '<option value="">Seleccionar paciente</option>';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.clienteID;
                option.textContent = `${cliente.nombre} ${cliente.apellido}`;
                selectCliente.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar clientes:', error);
            mostrarMensaje('Error al cargar clientes', 'error');
        }
    }

    async function cargarConsultas() {
        try {
            const response = await fetch(URL_API_CONSULTAS);
            if (!response.ok) throw new Error('Error al cargar consultas');
            
            const data = await response.json();
            
            // Mapa para resolver referencias
            const refMap = new Map();
            
            // Construir mapa de referencias
            function buildRefMap(obj) {
                if (!obj) return;
                
                if (obj.$id) {
                    refMap.set(obj.$id, obj);
                }
                
                // Procesar objetos anidados
                for (const key in obj) {
                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                        buildRefMap(obj[key]);
                    }
                }
            }
            
            // Procesar datos
            if (data.$id) {
                buildRefMap(data);
            }
            
            let consultasData = [];
            
            if (data.$values) {
                consultasData = data.$values;
            } else if (Array.isArray(data)) {
                consultasData = data;
            } else {
                console.error('Formato de datos de consultas inesperado:', data);
                consultasData = [];
            }
            
            // Procesar consultas y resolver referencias
            consultas = consultasData.map(consulta => {
                // Si es una referencia, resolverla
                if (consulta.$ref) {
                    consulta = refMap.get(consulta.$ref);
                    if (!consulta) return null;
                }
                
                return {
                    consultaID: consulta.consultaID,
                    medicoID: consulta.medicoID,
                    clienteID: consulta.clienteID,
                    fechaConsulta: consulta.fechaConsulta,
                    diagnostico: consulta.diagnostico,
                    tratamiento: consulta.tratamiento
                };
            }).filter(c => c !== null); // Eliminar las consultas nulas
            
            actualizarTablaConsultas();
        } catch (error) {
            console.error('Error al cargar consultas:', error);
            mostrarMensaje('Error al cargar consultas', 'error');
        }
    }

    // Función para filtrar médicos según la especialidad seleccionada
    // Mejorar la función de filtrado de médicos por especialidad
    function filtrarMedicosPorEspecialidad() {
        const especialidadId = selectEspecialidad.value;
        
        // Limpiar selector de médicos
        selectMedico.innerHTML = '<option value="">Seleccionar médico</option>';
        
        if (!especialidadId) return;
        
        console.log(`Filtrando médicos por especialidad ID: ${especialidadId}`);
        
        // Filtrar médicos por especialidad (convertir IDs a enteros para comparación)
        const medicosFiltrados = medicos.filter(medico => {
            return parseInt(medico.especialidadID) === parseInt(especialidadId);
        });
        
        console.log('Médicos filtrados:', medicosFiltrados);
        
        // Llenar selector con médicos filtrados
        medicosFiltrados.forEach(medico => {
            const option = document.createElement('option');
            option.value = medico.medicoID;
            option.textContent = `${medico.nombre} ${medico.apellido}`;
            selectMedico.appendChild(option);
        });
        
        // Si no hay médicos para la especialidad seleccionada
        if (medicosFiltrados.length === 0) {
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "No hay médicos disponibles para esta especialidad";
            option.disabled = true;
            selectMedico.appendChild(option);
        }
    }


    function actualizarFiltroMedicos() {
        const especialidadId = filterEspecialidad.value;
        
        // Limpiar selector de filtro de médicos
        filterMedico.innerHTML = '<option value="">Todos los médicos</option>';
        
        let medicosMostrar = medicos;
        
        // Si hay una especialidad seleccionada, filtrar médicos
        if (especialidadId) {
            medicosMostrar = medicos.filter(medico => 
                parseInt(medico.especialidadID) === parseInt(especialidadId)
            );
        }
        
        console.log('Médicos para filtro:', medicosMostrar);
        
        // Llenar selector de filtro con médicos
        medicosMostrar.forEach(medico => {
            const option = document.createElement('option');
            option.value = medico.medicoID;
            option.textContent = `${medico.nombre} ${medico.apellido}`;
            filterMedico.appendChild(option);
        });
    }

    // Operaciones CRUD para consultas
    async function guardarConsulta(e) {
        e.preventDefault();
        
        // Validar formulario
        if (!validarFormulario()) return;
        
        // Obtener datos del formulario
        const consultaId = document.getElementById('consultaId').value;
        const medicoId = selectMedico.value;
        const clienteId = selectCliente.value;
        const fechaConsulta = document.getElementById('fechaConsulta').value;
        const diagnostico = document.getElementById('diagnostico').value;
        const tratamiento = document.getElementById('tratamiento').value;
        
        // Crear objeto de consulta
        const consultaData = {
            medicoID: parseInt(medicoId),
            clienteID: parseInt(clienteId),
            fechaConsulta: fechaConsulta,
            diagnostico: diagnostico,
            tratamiento: tratamiento
        };
        
        try {
            let response;
            
            if (consultaId) {
                // Actualizar consulta existente
                consultaData.consultaID = parseInt(consultaId);
                response = await fetch(`${URL_API_CONSULTAS}/${consultaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(consultaData)
                });
                
                if (!response.ok) throw new Error('Error al actualizar la consulta');
                mostrarMensaje('Consulta actualizada correctamente', 'success');
            } else {
                // Crear nueva consulta
                response = await fetch(URL_API_CONSULTAS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(consultaData)
                });
                
                if (!response.ok) throw new Error('Error al crear la consulta');
                mostrarMensaje('Consulta guardada correctamente', 'success');
            }
            
            // Recargar consultas y limpiar formulario
            await cargarConsultas();
            limpiarFormulario();
            
        } catch (error) {
            console.error('Error al guardar consulta:', error);
            mostrarMensaje('Error al guardar la consulta', 'error');
        }
    }
    
    async function eliminarConsulta(consultaId) {
        if (!confirm('¿Está seguro de eliminar esta consulta?')) return;
        
        try {
            const response = await fetch(`${URL_API_CONSULTAS}/${consultaId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) throw new Error('Error al eliminar la consulta');
            
            mostrarMensaje('Consulta eliminada correctamente', 'success');
            await cargarConsultas();
            
        } catch (error) {
            console.error('Error al eliminar consulta:', error);
            mostrarMensaje('Error al eliminar la consulta', 'error');
        }
    }
    
    function editarConsulta(consulta) {
        console.log('Editando consulta:', consulta);
        
        // Establecer modo edición
        document.getElementById('formTitle').textContent = 'Editar Consulta';
        document.getElementById('consultaId').value = consulta.consultaID;
        
        // Obtener especialidad del médico
        const medico = medicos.find(m => m.medicoID == consulta.medicoID);
        if (!medico) {
            console.error('Médico no encontrado:', consulta.medicoID);
            return;
        }
        
        // Cargar datos en el formulario
        selectEspecialidad.value = medico.especialidadID;
        
        // Disparar el evento change para actualizar los médicos según la especialidad
        const event = new Event('change');
        selectEspecialidad.dispatchEvent(event);
        
        // Esperar un momento para que se actualice el selector de médicos
        setTimeout(() => {
            selectMedico.value = consulta.medicoID;
            selectCliente.value = consulta.clienteID;
            document.getElementById('fechaConsulta').value = formatearFechaISO(consulta.fechaConsulta);
            document.getElementById('diagnostico').value = consulta.diagnostico || '';
            document.getElementById('tratamiento').value = consulta.tratamiento || '';
            
            // Guardar referencia a la consulta que se está editando
            consultaEditando = consulta;
            
            // Desplazarse al formulario
            formConsulta.scrollIntoView({ behavior: 'smooth' });
        }, 300); // Aumentado a 300ms para dar más tiempo a la actualización del selector
    }
    
    function verDetalleConsulta(consulta) {
        console.log('Viendo detalles de consulta:', consulta);
        
        // Buscar médico por ID
        const medico = medicos.find(m => m.medicoID == consulta.medicoID);
        
        // Completar datos en el modal
        document.getElementById('detailEspecialidad').textContent = 
            medico ? obtenerNombreEspecialidad(medico.especialidadID) : 'No disponible';
        
        document.getElementById('detailMedico').textContent = 
            medico ? `${medico.nombre} ${medico.apellido}` : 'No disponible';
        
        const cliente = clientes.find(c => c.clienteID == consulta.clienteID);
        document.getElementById('detailPaciente').textContent = 
            cliente ? `${cliente.nombre} ${cliente.apellido}` : 'No disponible';
        
        document.getElementById('detailFecha').textContent = formatearFecha(consulta.fechaConsulta);
        document.getElementById('detailDiagnostico').textContent = consulta.diagnostico || 'No registrado';
        document.getElementById('detailTratamiento').textContent = consulta.tratamiento || 'No registrado';
        
        // Mostrar modal
        consultaModal.style.display = 'block';
    }
    
    function cerrarModal() {
        consultaModal.style.display = 'none';
    }
    
    function limpiarFormulario() {
        document.getElementById('formTitle').textContent = 'Nueva Consulta';
        document.getElementById('consultaId').value = '';
        formConsulta.reset();
        selectMedico.innerHTML = '<option value="">Seleccionar médico</option>';
        consultaEditando = null;
    }
    
    // Función para validar el formulario
    function validarFormulario() {
        const medicoId = selectMedico.value;
        const clienteId = selectCliente.value;
        const fechaConsulta = document.getElementById('fechaConsulta').value;
        
        if (!medicoId) {
            mostrarMensaje('Debe seleccionar un médico', 'error');
            return false;
        }
        
        if (!clienteId) {
            mostrarMensaje('Debe seleccionar un paciente', 'error');
            return false;
        }
        
        if (!fechaConsulta) {
            mostrarMensaje('Debe seleccionar una fecha de consulta', 'error');
            return false;
        }
        
        return true;
    }

    // Funciones para la tabla de consultas
    function actualizarTablaConsultas(consultasFiltradas = null) {
        const tabla = document.getElementById('tablaConsultas').getElementsByTagName('tbody')[0];
    const listaConsultas = consultasFiltradas || consultas;
        
        // Limpiar tabla
        tabla.innerHTML = '';
        
        if (listaConsultas.length === 0) {
            const fila = tabla.insertRow();
            const celda = fila.insertCell();
            celda.colSpan = 8;
            celda.textContent = 'No hay consultas registradas';
            celda.className = 'no-data';
            return;
        }
        
        // Llenar tabla con datos
        listaConsultas.forEach(consulta => {
            const fila = tabla.insertRow();
            
            // Buscar médico
            const medico = medicos.find(m => m.medicoID == consulta.medicoID);
            
            // Buscar especialidad
            let especialidadNombre = 'Desconocida';
            if (medico) {
                especialidadNombre = obtenerNombreEspecialidad(medico.especialidadID);
            }
            
            // Buscar cliente
            const cliente = clientes.find(c => c.clienteID == consulta.clienteID);
            
            // Insertar celdas
            fila.insertCell().textContent = consulta.consultaID;
            fila.insertCell().textContent = medico ? `${medico.nombre} ${medico.apellido}` : 'Desconocido';
            fila.insertCell().textContent = especialidadNombre;
            fila.insertCell().textContent = cliente ? `${cliente.nombre} ${cliente.apellido}` : 'Desconocido';
            fila.insertCell().textContent = formatearFecha(consulta.fechaConsulta);
            
            const celdaDiagnostico = fila.insertCell();
            celdaDiagnostico.textContent = consulta.diagnostico ? 
                (consulta.diagnostico.length > 20 ? consulta.diagnostico.substring(0, 20) + '...' : consulta.diagnostico) : 
                'No registrado';
            
            const celdaTratamiento = fila.insertCell();
            celdaTratamiento.textContent = consulta.tratamiento ? 
                (consulta.tratamiento.length > 20 ? consulta.tratamiento.substring(0, 20) + '...' : consulta.tratamiento) : 
                'No registrado';
            
            // Celda de acciones
            const celdaAcciones = fila.insertCell();
            
            // Botón ver detalles
            const btnVer = document.createElement('button');
            btnVer.innerHTML = '<i class="fas fa-eye"></i>';
            btnVer.className = 'btn-icon btn-view';
            btnVer.title = 'Ver detalles';
            btnVer.onclick = () => verDetalleConsulta(consulta);
            celdaAcciones.appendChild(btnVer);
            
            // Botón editar
            const btnEditar = document.createElement('button');
            btnEditar.innerHTML = '<i class="fas fa-edit"></i>';
            btnEditar.className = 'btn-icon btn-edit';
            btnEditar.title = 'Editar';
            btnEditar.onclick = () => editarConsulta(consulta);
            celdaAcciones.appendChild(btnEditar);
            
            // Botón eliminar
            const btnEliminar = document.createElement('button');
            btnEliminar.innerHTML = '<i class="fas fa-trash"></i>';
            btnEliminar.className = 'btn-icon btn-delete';
            btnEliminar.title = 'Eliminar';
            btnEliminar.onclick = () => eliminarConsulta(consulta.consultaID);
            celdaAcciones.appendChild(btnEliminar);
        });
    }
    
    // Funciones para filtrado y búsqueda
    function aplicarFiltros() {
        const filtroEspecialidad = filterEspecialidad.value;
        const filtroMedico = filterMedico.value;
        const filtroFecha = filterFecha.value;
        const textoBusqueda = searchInput.value.toLowerCase();
        
        // Aplicar filtros
        let consultasFiltradas = consultas;
        
        // Filtrar por especialidad (a través del médico)
        if (filtroEspecialidad) {
            consultasFiltradas = consultasFiltradas.filter(consulta => {
                const medico = medicos.find(m => m.medicoID == consulta.medicoID);
                return medico && parseInt(medico.especialidadID) === parseInt(filtroEspecialidad);
            });
        }
        
        // Filtrar por médico
        if (filtroMedico) {
            consultasFiltradas = consultasFiltradas.filter(consulta => 
                parseInt(consulta.medicoID) === parseInt(filtroMedico)
            );
        }
        
        // Filtrar por fecha
        if (filtroFecha) {
            const fechaSeleccionada = new Date(filtroFecha);
            fechaSeleccionada.setHours(0, 0, 0, 0);
            
            consultasFiltradas = consultasFiltradas.filter(consulta => {
                const fechaConsulta = new Date(consulta.fechaConsulta);
                fechaConsulta.setHours(0, 0, 0, 0);
                return fechaConsulta.getTime() === fechaSeleccionada.getTime();
            });
        }
        
        // Buscar por texto
        if (textoBusqueda) {
            consultasFiltradas = consultasFiltradas.filter(consulta => {
                // Buscar en médico
                const medico = medicos.find(m => m.medicoID == consulta.medicoID);
                const nombreMedico = medico ? `${medico.nombre} ${medico.apellido}`.toLowerCase() : '';
                
                // Buscar en cliente
                const cliente = clientes.find(c => c.clienteID == consulta.clienteID);
                const nombreCliente = cliente ? `${cliente.nombre} ${cliente.apellido}`.toLowerCase() : '';
                
                // Buscar en diagnóstico y tratamiento
                const diagnostico = (consulta.diagnostico || '').toLowerCase();
                const tratamiento = (consulta.tratamiento || '').toLowerCase();
                
                return nombreMedico.includes(textoBusqueda) || 
                       nombreCliente.includes(textoBusqueda) || 
                       diagnostico.includes(textoBusqueda) || 
                       tratamiento.includes(textoBusqueda);
            });
        }
        
        // Actualizar tabla con resultados filtrados
        actualizarTablaConsultas(consultasFiltradas);
    }
    
    // Funciones utilitarias
    function obtenerNombreEspecialidad(especialidadId) {
        if (!especialidadId) return 'Desconocida';
        
        const especialidadIdInt = parseInt(especialidadId);
        const especialidad = especialidades.find(e => parseInt(e.especialidadID) === especialidadIdInt);
        return especialidad ? especialidad.nombre : 'Desconocida';
    }
    
    function formatearFecha(fechaStr) {
        if (!fechaStr) return 'Fecha no disponible';
        
        try {
            const fecha = new Date(fechaStr);
            return fecha.toLocaleString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            });
        } catch (error) {
            console.error('Error al formatear fecha:', error);
            return 'Fecha inválida';
        }
    }
    
    function formatearFechaISO(fechaStr) {
        if (!fechaStr) return '';
        
        try {
            const fecha = new Date(fechaStr);
            const tzoffset = fecha.getTimezoneOffset() * 60000; // offset en milisegundos
            const fechaLocal = new Date(fecha.getTime() - tzoffset);
            return fechaLocal.toISOString().slice(0, 16); // Formato: YYYY-MM-DDTHH:MM
        } catch (error) {
            console.error('Error al formatear fecha ISO:', error);
            return '';
        }
    }
    
    function mostrarMensaje(mensaje, tipo) {
        alert(mensaje);
    }
    
    // Cerrar modal al hacer clic fuera de él
    window.onclick = function(event) {
        if (event.target == consultaModal) {
            cerrarModal();
        }
    };
});

EMPLEADOS



ESPECIALIADES



INDEX



MÉDICOS


